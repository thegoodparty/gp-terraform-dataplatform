name: Terraform Plan

on:
  pull_request:
    branches:
      - main
    paths:
      - '*.tf'
      - 'config/*.tfvars'
      - 'config/*.yaml'
      - '.github/workflows/deploy-prod.yml'

  push:
    branches:
      - main
    paths:
      - '*.tf'
      - 'config/*.tfvars'
      - 'config/*.yaml'
      - '.github/workflows/deploy-prod.yml'

  workflow_dispatch:

env:
  TF_VERSION: '1.14.4'

jobs:
  terraform:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars << EOF
          databricks_account_id = "${{ vars.DATABRICKS_ACCOUNT_ID }}"
          workspace_id          = "${{ vars.DATABRICKS_WORKSPACE_ID }}"
          astro_organization_id = "${{ vars.ASTRO_ORGANIZATION_ID }}"
          EOF

      - name: Terraform Init
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
        run: |
          terraform plan \
            -var-file=config/prod.tfvars \
            -target=astro_workspace.data_engineering \
            -target=astro_deployment.environments \
            -out=tfplan

      - name: Analyze Plan
        id: analyze
        run: |
          # Convert plan to JSON and extract resource changes
          terraform show -json tfplan > tfplan.json

          # Count changes by action type
          ADDS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not)] | length' tfplan.json)
          CHANGES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["update"]))] | length' tfplan.json)
          DESTROYS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["delete"]))] | length' tfplan.json)
          REPLACES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]))] | length' tfplan.json)

          # Get resource lists
          ADD_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not) | .address] | join("\n")' tfplan.json)
          CHANGE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["update"])) | .address] | join("\n")' tfplan.json)
          DESTROY_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["delete"])) | select(.change.actions | contains(["create"]) | not) | .address] | join("\n")' tfplan.json)
          REPLACE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"])) | .address] | join("\n")' tfplan.json)

          echo "adds=$ADDS" >> $GITHUB_OUTPUT
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT
          echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT
          echo "replaces=$REPLACES" >> $GITHUB_OUTPUT

          # Store lists in files for the PR comment step
          echo "$ADD_LIST" > /tmp/add_list.txt
          echo "$CHANGE_LIST" > /tmp/change_list.txt
          echo "$DESTROY_LIST" > /tmp/destroy_list.txt
          echo "$REPLACE_LIST" > /tmp/replace_list.txt

          # Build summary
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Action | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Create | $ADDS | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Update | $CHANGES | ⚠️ |" >> $GITHUB_STEP_SUMMARY
          echo "| Replace | $REPLACES | ❌ |" >> $GITHUB_STEP_SUMMARY
          echo "| Destroy | $DESTROYS | ❌ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ADDS" -gt 0 ]; then
            echo "### Resources to create:" >> $GITHUB_STEP_SUMMARY
            echo "$ADD_LIST" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY; done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$CHANGES" -gt 0 ]; then
            echo "### Resources to update:" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGE_LIST" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY; done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$REPLACES" -gt 0 ]; then
            echo "### ⚠️ Resources to replace (destroy + create):" >> $GITHUB_STEP_SUMMARY
            echo "$REPLACE_LIST" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY; done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DESTROYS" -gt 0 ]; then
            echo "### ❌ Resources to destroy:" >> $GITHUB_STEP_SUMMARY
            echo "$DESTROY_LIST" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY; done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$ADDS" -eq 0 ] && [ "$CHANGES" -eq 0 ] && [ "$DESTROYS" -eq 0 ] && [ "$REPLACES" -eq 0 ]; then
            echo "### ✅ No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const adds = ${{ steps.analyze.outputs.adds }};
            const changes = ${{ steps.analyze.outputs.changes }};
            const destroys = ${{ steps.analyze.outputs.destroys }};
            const replaces = ${{ steps.analyze.outputs.replaces }};

            const addList = fs.readFileSync('/tmp/add_list.txt', 'utf8').trim();
            const changeList = fs.readFileSync('/tmp/change_list.txt', 'utf8').trim();
            const destroyList = fs.readFileSync('/tmp/destroy_list.txt', 'utf8').trim();
            const replaceList = fs.readFileSync('/tmp/replace_list.txt', 'utf8').trim();

            let status = '✅ Safe to merge';
            if (destroys > 0 || replaces > 0) {
              status = '❌ Requires manual review - resources will be destroyed';
            } else if (changes > 0) {
              status = '⚠️ Review recommended - resources will be modified';
            }

            const formatList = (list) => list ? list.split('\n').filter(x => x).map(x => `- \`${x}\``).join('\n') : '';

            let details = '';
            if (adds > 0) details += `\n### Resources to create:\n${formatList(addList)}\n`;
            if (changes > 0) details += `\n### Resources to update:\n${formatList(changeList)}\n`;
            if (replaces > 0) details += `\n### ⚠️ Resources to replace:\n${formatList(replaceList)}\n`;
            if (destroys > 0) details += `\n### ❌ Resources to destroy:\n${formatList(destroyList)}\n`;

            const body = `## Terraform Plan Results

            | Action | Count | Status |
            |--------|-------|--------|
            | Create | ${adds} | ✅ |
            | Update | ${changes} | ⚠️ |
            | Replace | ${replaces} | ❌ |
            | Destroy | ${destroys} | ❌ |

            **${status}**
            ${details}
            <details>
            <summary>What do these mean?</summary>

            - **Create**: New resources will be added
            - **Update**: Existing resources will be modified in-place
            - **Replace**: Resources will be destroyed and recreated (data loss possible)
            - **Destroy**: Resources will be permanently deleted

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on Destroy
        if: steps.analyze.outputs.destroys != '0' || steps.analyze.outputs.replaces != '0'
        run: |
          echo "::error::Plan contains ${{ steps.analyze.outputs.destroys }} destroy(s) and ${{ steps.analyze.outputs.replaces }} replace(s). Manual review required."
          exit 1
