name: PR Terraform Plan

on:
  pull_request:
    branches:
      - main

jobs:
  plan:
    name: Plan
    uses: ./.github/workflows/tf-plan.yaml
    secrets: inherit

  comment:
    name: Comment on PR
    needs: plan
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Download Plan Summary
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: artifacts

      - name: Add Deploy Instructions to Summary
        run: |
          cat >> artifacts/plan_summary.md << 'EOF'

          ---

          **To apply these changes:**

          1. **Merge** this PR to `main`
          2. **Review** the plan in the workflow run triggered by the merge
          3. **Deploy** via Actions → Deploy → Run workflow → uncheck "Dry run"

          Or via CLI after merge: `gh workflow run deploy.yaml -f dry_run=false`
          EOF

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- terraform-plan-comment -->';
            const summary = fs.readFileSync('artifacts/plan_summary.md', 'utf8');
            const body = marker + '\n' + summary;

            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            for (const comment of comments) {
              if (comment.body.includes(marker)) {
                await github.rest.issues.deleteComment({
                  comment_id: comment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              }
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  check-destructive:
    name: Check Destructive Changes
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - name: Warn on Destroy/Replace
        if: needs.plan.outputs.destroys != '0' || needs.plan.outputs.replaces != '0'
        run: |
          echo "::warning::Plan contains ${{ needs.plan.outputs.destroys }} destroy(s) and ${{ needs.plan.outputs.replaces }} replace(s). Please review carefully before merging."
