name: Terraform CI/CD

on:
  pull_request:
    branches:
      - main

  push:
    branches:
      - main

  workflow_dispatch:

env:
  TF_VERSION: '1.14.4'

jobs:
  terraform:
    name: Terraform Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Create terraform.tfvars
        env:
          # Use env mapping to prevent script injection from GitHub variables
          DATABRICKS_ACCOUNT_ID: ${{ vars.DATABRICKS_ACCOUNT_ID }}
          DATABRICKS_WORKSPACE_HOST: ${{ vars.DATABRICKS_WORKSPACE_HOST }}
          WORKSPACE_ID: ${{ vars.DATABRICKS_WORKSPACE_ID }}
          ASTRO_ORGANIZATION_ID: ${{ vars.ASTRO_ORGANIZATION_ID }}
          ASTRO_CONTACT_EMAILS: ${{ vars.ASTRO_CONTACT_EMAILS }}
        run: |
          # Convert comma-separated emails to Terraform list format
          EMAILS_LIST=$(echo "$ASTRO_CONTACT_EMAILS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length > 0))' | tr -d '[]')
          if [ -z "$EMAILS_LIST" ]; then
            echo "::error::ASTRO_CONTACT_EMAILS is empty or not configured"
            exit 1
          fi

          # Write terraform.tfvars using environment variables (safe from injection)
          # Note: Databricks auth uses DATABRICKS_CLIENT_ID/SECRET env vars directly
          cat > terraform.tfvars << EOF
          databricks_account_id     = "${DATABRICKS_ACCOUNT_ID}"
          databricks_workspace_host = "${DATABRICKS_WORKSPACE_HOST}"
          workspace_id              = "${WORKSPACE_ID}"
          astro_organization_id     = "${ASTRO_ORGANIZATION_ID}"
          astro_contact_emails      = [${EMAILS_LIST}]
          EOF

      - name: Terraform Init
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
          DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
        run: terraform plan -var-file=config/dev.tfvars -var-file=config/prod.tfvars -out=tfplan

      - name: Analyze Plan
        id: analyze
        run: |
          # Convert plan to JSON and extract resource changes
          terraform show -json tfplan > tfplan.json

          # Count changes by action type
          ADDS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not)] | length' tfplan.json)
          CHANGES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["update"]))] | length' tfplan.json)
          DESTROYS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["delete"])) | select(.change.actions | contains(["create"]) | not)] | length' tfplan.json)
          REPLACES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]))] | length' tfplan.json)

          # Get resource lists
          ADD_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not) | .address] | join("\n")' tfplan.json)
          CHANGE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["update"])) | .address] | join("\n")' tfplan.json)
          DESTROY_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["delete"])) | select(.change.actions | contains(["create"]) | not) | .address] | join("\n")' tfplan.json)
          REPLACE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"])) | .address] | join("\n")' tfplan.json)

          echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT
          echo "replaces=$REPLACES" >> $GITHUB_OUTPUT

          # Determine status
          if [ "$DESTROYS" -gt 0 ] || [ "$REPLACES" -gt 0 ]; then
            STATUS="❌ Requires manual review - resources will be destroyed"
          elif [ "$CHANGES" -gt 0 ]; then
            STATUS="⚠️ Review recommended - resources will be modified"
          else
            STATUS="✅ Safe to merge"
          fi

          # Helper function to format resource list
          format_list() {
            echo "$1" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`"; done
          }

          # Build markdown body
          {
            echo "# Terraform Plan Results"
            echo ""
            echo "| Action | Count | Status |"
            echo "|--------|-------|--------|"
            echo "| Create | $ADDS | ✅ |"
            echo "| Update | $CHANGES | ⚠️ |"
            echo "| Replace | $REPLACES | ❌ |"
            echo "| Destroy | $DESTROYS | ❌ |"
            echo ""
            echo "**${STATUS}**"

            if [ "$ADDS" -gt 0 ]; then
              echo ""
              echo "## Resources to create:"
              format_list "$ADD_LIST"
            fi

            if [ "$CHANGES" -gt 0 ]; then
              echo ""
              echo "## Resources to update:"
              format_list "$CHANGE_LIST"
            fi

            if [ "$REPLACES" -gt 0 ]; then
              echo ""
              echo "## ⚠️ Resources to replace:"
              format_list "$REPLACE_LIST"
            fi

            if [ "$DESTROYS" -gt 0 ]; then
              echo ""
              echo "## ❌ Resources to destroy:"
              format_list "$DESTROY_LIST"
            fi

            if [ "$ADDS" -eq 0 ] && [ "$CHANGES" -eq 0 ] && [ "$DESTROYS" -eq 0 ] && [ "$REPLACES" -eq 0 ]; then
              echo ""
              echo "## ✅ No changes detected"
            fi

            echo ""
            echo "---"
            echo ""
            echo "<details>"
            echo "<summary>What do these mean?</summary>"
            echo ""
            echo "- **Create**: New resources will be added"
            echo "- **Update**: Existing resources will be modified in-place"
            echo "- **Replace**: Resources will be destroyed and recreated (data loss possible)"
            echo "- **Destroy**: Resources will be permanently deleted"
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo ""
            echo "**To apply these changes after merging:**"
            echo "\`\`\`bash"
            echo "source .env"
            echo "terraform apply -var-file=config/dev.tfvars -var-file=config/prod.tfvars"
            echo "\`\`\`"
          } > plan_summary.md

          # Write to step summary
          cat plan_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- terraform-plan-comment -->';
            const summary = fs.readFileSync('plan_summary.md', 'utf8');
            const body = marker + '\n' + summary;

            // Find and delete previous terraform plan comments
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            for (const comment of comments) {
              if (comment.body.includes(marker)) {
                await github.rest.issues.deleteComment({
                  comment_id: comment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              }
            }

            // Create new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on Destroy (PR only)
        if: github.event_name == 'pull_request' && (steps.analyze.outputs.destroys != '0' || steps.analyze.outputs.replaces != '0')
        run: |
          echo "::error::Plan contains ${{ steps.analyze.outputs.destroys }} destroy(s) and ${{ steps.analyze.outputs.replaces }} replace(s). Manual review required."
          exit 1

      - name: Apply Instructions
        if: github.event_name == 'push'
        run: |
          echo "::notice::Plan complete. Apply manually when ready."
          echo ""
          echo "To apply changes:"
          echo "  source .env"
          echo "  terraform apply -var-file=config/dev.tfvars -var-file=config/prod.tfvars"
