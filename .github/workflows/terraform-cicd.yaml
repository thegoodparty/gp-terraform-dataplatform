name: Terraform CI/CD

on:
  pull_request:
    branches:
      - main
    paths:
      - '*.tf'
      - 'config/*.tfvars'
      - 'config/*.yaml'
      - '.github/workflows/terraform-cicd.yaml'

  push:
    branches:
      - main
    paths:
      - '*.tf'
      - 'config/*.tfvars'
      - 'config/*.yaml'
      - '.github/workflows/terraform-cicd.yaml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - dev
          - prod

env:
  TF_VERSION: '1.14.4'

jobs:
  terraform:
    name: Terraform (${{ matrix.environment }})
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    strategy:
      fail-fast: false
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment != 'all' && fromJson(format('["{0}"]', github.event.inputs.environment)) || fromJson('["dev", "prod"]') }}

    outputs:
      dev_destroys: ${{ steps.analyze.outputs.destroys }}
      dev_replaces: ${{ steps.analyze.outputs.replaces }}
      prod_destroys: ${{ steps.analyze.outputs.destroys }}
      prod_replaces: ${{ steps.analyze.outputs.replaces }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Create terraform.tfvars
        run: |
          # Convert comma-separated emails to Terraform list format
          EMAILS_LIST=$(echo '${{ vars.ASTRO_CONTACT_EMAILS }}' | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length > 0))' | tr -d '[]')
          if [ -z "$EMAILS_LIST" ]; then
            echo "::error::ASTRO_CONTACT_EMAILS is empty or not configured"
            exit 1
          fi
          cat > terraform.tfvars << EOF
          databricks_account_id     = "${{ vars.DATABRICKS_ACCOUNT_ID }}"
          databricks_workspace_host = "${{ vars.DATABRICKS_WORKSPACE_HOST }}"
          databricks_client_id      = "${{ secrets.DATABRICKS_CLIENT_ID }}"
          databricks_client_secret  = "${{ secrets.DATABRICKS_CLIENT_SECRET }}"
          workspace_id              = "${{ vars.DATABRICKS_WORKSPACE_ID }}"
          astro_organization_id     = "${{ vars.ASTRO_ORGANIZATION_ID }}"
          astro_contact_emails      = [${EMAILS_LIST}]
          EOF

      - name: Terraform Init
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        env:
          ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
        run: |
          terraform plan \
            -var-file=config/${{ matrix.environment }}.tfvars \
            -out=tfplan

      - name: Analyze Plan
        id: analyze
        run: |
          # Convert plan to JSON and extract resource changes
          terraform show -json tfplan > tfplan.json

          # Count changes by action type
          ADDS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not)] | length' tfplan.json)
          CHANGES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["update"]))] | length' tfplan.json)
          DESTROYS=$(jq '[.resource_changes[]? | select(.change.actions | contains(["delete"])) | select(.change.actions | contains(["create"]) | not)] | length' tfplan.json)
          REPLACES=$(jq '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]))] | length' tfplan.json)

          # Get resource lists
          ADD_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"]) | not) | .address] | join("\n")' tfplan.json)
          CHANGE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["update"])) | .address] | join("\n")' tfplan.json)
          DESTROY_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["delete"])) | select(.change.actions | contains(["create"]) | not) | .address] | join("\n")' tfplan.json)
          REPLACE_LIST=$(jq -r '[.resource_changes[]? | select(.change.actions | contains(["create"])) | select(.change.actions | contains(["delete"])) | .address] | join("\n")' tfplan.json)

          echo "destroys=$DESTROYS" >> $GITHUB_OUTPUT
          echo "replaces=$REPLACES" >> $GITHUB_OUTPUT

          # Determine status
          if [ "$DESTROYS" -gt 0 ] || [ "$REPLACES" -gt 0 ]; then
            STATUS="❌ Requires manual review - resources will be destroyed"
          elif [ "$CHANGES" -gt 0 ]; then
            STATUS="⚠️ Review recommended - resources will be modified"
          else
            STATUS="✅ Safe to merge"
          fi

          # Helper function to format resource list
          format_list() {
            echo "$1" | while read -r line; do [ -n "$line" ] && echo "- \`$line\`"; done
          }

          # Build markdown body
          {
            echo "## ${{ matrix.environment }}"
            echo ""
            echo "| Action | Count | Status |"
            echo "|--------|-------|--------|"
            echo "| Create | $ADDS | ✅ |"
            echo "| Update | $CHANGES | ⚠️ |"
            echo "| Replace | $REPLACES | ❌ |"
            echo "| Destroy | $DESTROYS | ❌ |"
            echo ""
            echo "**${STATUS}**"

            if [ "$ADDS" -gt 0 ]; then
              echo ""
              echo "### Resources to create:"
              format_list "$ADD_LIST"
            fi

            if [ "$CHANGES" -gt 0 ]; then
              echo ""
              echo "### Resources to update:"
              format_list "$CHANGE_LIST"
            fi

            if [ "$REPLACES" -gt 0 ]; then
              echo ""
              echo "### ⚠️ Resources to replace:"
              format_list "$REPLACE_LIST"
            fi

            if [ "$DESTROYS" -gt 0 ]; then
              echo ""
              echo "### ❌ Resources to destroy:"
              format_list "$DESTROY_LIST"
            fi

            if [ "$ADDS" -eq 0 ] && [ "$CHANGES" -eq 0 ] && [ "$DESTROYS" -eq 0 ] && [ "$REPLACES" -eq 0 ]; then
              echo ""
              echo "### ✅ No changes detected"
            fi
          } > plan_summary_${{ matrix.environment }}.md

          # Write to step summary
          cat plan_summary_${{ matrix.environment }}.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan Summary
        uses: actions/upload-artifact@v4
        with:
          name: plan-summary-${{ matrix.environment }}
          path: plan_summary_${{ matrix.environment }}.md
          retention-days: 1

      - name: Apply Instructions
        if: github.event_name == 'push'
        run: |
          ENV="${{ matrix.environment }}"
          echo "::notice::Plan complete for $ENV. Apply manually when ready."
          echo ""
          echo "To apply $ENV changes:"
          echo "  terraform apply -var-file=config/$ENV.tfvars"

  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Download Plan Summaries
        uses: actions/download-artifact@v4
        with:
          pattern: plan-summary-*
          merge-multiple: true

      - name: Create Combined Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- terraform-plan-comment -->';

            // Read available summaries
            let body = marker + '\n# Terraform Plan Results\n\n';

            const envs = ['dev', 'prod'];
            for (const env of envs) {
              const file = `plan_summary_${env}.md`;
              if (fs.existsSync(file)) {
                body += fs.readFileSync(file, 'utf8') + '\n\n';
              }
            }

            // Add legend and apply instructions
            body += `---

<details>
<summary>What do these mean?</summary>

- **Create**: New resources will be added
- **Update**: Existing resources will be modified in-place
- **Replace**: Resources will be destroyed and recreated (data loss possible)
- **Destroy**: Resources will be permanently deleted

</details>

---

**To apply these changes after merging:**
\`\`\`bash
source .env
# For dev
terraform plan -var-file=config/dev.tfvars
terraform apply -var-file=config/dev.tfvars

# For prod
terraform plan -var-file=config/prod.tfvars
terraform apply -var-file=config/prod.tfvars
\`\`\``;

            // Find and delete previous terraform plan comments
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            for (const comment of comments) {
              if (comment.body.includes(marker)) {
                await github.rest.issues.deleteComment({
                  comment_id: comment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              }
            }

            // Create new comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  check-destroys:
    name: Check for Destroys
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event_name == 'pull_request'

    steps:
      - name: Download Plan Summaries
        uses: actions/download-artifact@v4
        with:
          pattern: plan-summary-*
          merge-multiple: true

      - name: Check for Destructive Changes
        run: |
          FAILED=false
          for file in plan_summary_*.md; do
            if [ -f "$file" ]; then
              ENV=$(echo "$file" | sed 's/plan_summary_\(.*\)\.md/\1/')
              if grep -q "❌ Requires manual review" "$file"; then
                echo "::error::$ENV plan contains destructive changes. Manual review required."
                FAILED=true
              fi
            fi
          done
          if [ "$FAILED" = true ]; then
            exit 1
          fi
